# Android è§†é¢‘æ’­æ”¾å™¨é¡¹ç›® (VMPlayer)

## é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº Android å¹³å°å¼€å‘çš„**å®éªŒæ€§**è§†é¢‘æ’­æ”¾å™¨é¡¹ç›®ï¼Œæ˜¯å¯¹è§†é¢‘æ’­æ”¾å™¨æ¸²æŸ“æŠ€æœ¯æ·±å…¥æ¢ç´¢çš„æˆæœã€‚é¡¹ç›®æ”¯æŒå¤šè§†é¢‘ç‰‡æ®µæ’­æ”¾ã€å®æ—¶é¢„è§ˆã€è§†é¢‘å¯¼å‡ºç­‰åŠŸèƒ½ï¼Œé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼ŒåŒ…å«è‡ªå®šä¹‰çš„åª’ä½“å¤„ç†æ¡†æ¶å’Œæ’­æ”¾å™¨å®ç°ã€‚

> **æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªä¸ªäººå­¦ä¹ å’ŒæŠ€æœ¯æ¢ç´¢é¡¹ç›®ï¼Œä¸»è¦ç”¨äºç ”ç©¶è§†é¢‘æ¸²æŸ“ã€OpenGL ESã€éŸ³è§†é¢‘åŒæ­¥ã€MediaCodecç¼–è§£ç ç­‰æŠ€æœ¯ã€‚ä»£ç ä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œä¸å»ºè®®ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

## æŠ€æœ¯æ¢ç´¢é‡ç‚¹

æœ¬é¡¹ç›®é‡ç‚¹æ¢ç´¢å’Œå®è·µäº†ä»¥ä¸‹æŠ€æœ¯é¢†åŸŸï¼š

- ğŸ¬ **è‡ªå®šä¹‰è§†é¢‘æ¸²æŸ“ç®¡çº¿**: åŸºäº OpenGL ES æ„å»ºå®Œæ•´æ¸²æŸ“æµç¨‹
- ğŸµ **éŸ³è§†é¢‘åŒæ­¥æœºåˆ¶**: ç²¾ç¡®çš„æ—¶é—´è½´ç®¡ç†å’ŒéŸ³è§†é¢‘åŒæ­¥ç®—æ³•
- âš¡ **å¤šçº¿ç¨‹æ¶æ„**: è§£ç ã€æ¸²æŸ“ã€éŸ³é¢‘æ’­æ”¾çš„çº¿ç¨‹åè°ƒï¼ˆHandler + Threadï¼‰
- ğŸ”„ **å†…å­˜ç®¡ç†ä¼˜åŒ–**: çº¹ç†ç¼“å­˜ã€è§£ç å™¨èµ„æºç®¡ç†
- ğŸ“¤ **è§†é¢‘å¯¼å‡ºæŠ€æœ¯**: MediaCodec ç¼–è§£ç å’Œ MediaMuxer æ–‡ä»¶è¾“å‡º
- ğŸ¯ **ç‰‡æ®µåŒ–æ’­æ”¾**: æ”¯æŒå¤šè§†é¢‘ç‰‡æ®µçš„æ— ç¼æ‹¼æ¥æ’­æ”¾
- ğŸ”§ **è§£è€¦æ¶æ„è®¾è®¡**: æ’­æ”¾å™¨ã€è§£ç å™¨ã€ç¼–ç å™¨ã€æ¸²æŸ“å™¨çš„æ¨¡å—åŒ–è®¾è®¡

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **å¤šè§†é¢‘ç‰‡æ®µæ’­æ”¾**: æ”¯æŒæ’­æ”¾å¤šä¸ªè§†é¢‘ç‰‡æ®µç»„æˆçš„æ’­æ”¾åˆ—è¡¨ï¼ˆTrackSegmentï¼‰
- âœ… **å®æ—¶è§†é¢‘é¢„è§ˆ**: åŸºäº OpenGL ES çš„è§†é¢‘æ¸²æŸ“ï¼ˆSurfaceæ¸²æŸ“ï¼‰
- âœ… **è§†é¢‘å¯¼å‡º**: æ”¯æŒå°†æ’­æ”¾åˆ—è¡¨å¯¼å‡ºä¸ºå•ä¸ª MP4 æ–‡ä»¶
- âœ… **æ’­æ”¾æ§åˆ¶**: æ’­æ”¾ã€æš‚åœã€åœæ­¢ã€Seekã€è¿›åº¦æ§åˆ¶
- âœ… **æ—¶é—´è½´ç®¡ç†**: ç²¾ç¡®çš„æ—¶é—´è½´ç®¡ç†å’Œç‰‡æ®µåˆ‡æ¢
- âœ… **éŸ³è§†é¢‘åŒæ­¥**: åŸºäº AudioTrack çš„éŸ³è§†é¢‘åŒæ­¥æ’­æ”¾
- âœ… **æ ¼å¼æ”¯æŒ**: æ”¯æŒå¸¸è§è§†é¢‘æ ¼å¼ï¼ˆMP4ã€H.264ã€AACç­‰ï¼‰

### å¯¼å‡ºåŠŸèƒ½ç‰¹æ€§

- ğŸ¥ **è§†é¢‘ç¼–ç **: H.264/AVC è§†é¢‘ç¼–ç 
- ğŸµ **éŸ³é¢‘ç¼–ç **: AAC éŸ³é¢‘ç¼–ç 
- ğŸ“Š **å®æ—¶è¿›åº¦**: å¯¼å‡ºè¿›åº¦å›è°ƒ
- âš™ï¸ **å¯é…ç½®å‚æ•°**: åˆ†è¾¨ç‡ã€ç ç‡ã€å¸§ç‡å¯è‡ªå®šä¹‰
- ğŸ”„ **å¤šçº¿ç¨‹å¤„ç†**: éŸ³è§†é¢‘ç‹¬ç«‹çº¿ç¨‹å¤„ç†ï¼Œæé«˜å¯¼å‡ºæ•ˆç‡

## é¡¹ç›®ç»“æ„

```
VMPlayer/
â”œâ”€â”€ media/                                  # åª’ä½“å¤„ç†æ ¸å¿ƒæ¨¡å—
â”‚   â””â”€â”€ src/main/java/com/vompom/media/
â”‚       â”‚
â”‚       â”œâ”€â”€ player/                         # æ’­æ”¾å™¨æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ PlayerThread.kt            # è§†é¢‘æ’­æ”¾çº¿ç¨‹ï¼ˆHandlerThreadï¼‰
â”‚       â”‚   â”œâ”€â”€ PlayerThreadAudio.kt       # éŸ³é¢‘æ’­æ”¾çº¿ç¨‹ï¼ˆHandlerThreadï¼‰
â”‚       â”‚   â”œâ”€â”€ PlayerMessageVideoCallback.kt  # æ’­æ”¾å™¨æ¶ˆæ¯å›è°ƒ
â”‚       â”‚   â””â”€â”€ AVSyncManager.kt           # éŸ³è§†é¢‘åŒæ­¥ç®¡ç†å™¨
â”‚       â”‚
â”‚       â”œâ”€â”€ docode/                       # è§£ç å™¨æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ decorder/                 # è§£ç å™¨å®ç°
â”‚       â”‚   â”‚   â”œâ”€â”€ IDecoder.kt           # è§£ç å™¨æ¥å£
â”‚       â”‚   â”‚   â”œâ”€â”€ BaseDecoder.kt        # è§£ç å™¨åŸºç±»
â”‚       â”‚   â”‚   â”œâ”€â”€ VideoDecoder.kt       # è§†é¢‘è§£ç å™¨
â”‚       â”‚   â”‚   â””â”€â”€ AudioDecoder.kt       # éŸ³é¢‘è§£ç å™¨
â”‚       â”‚   â”œâ”€â”€ track/                    # è½¨é“ç®¡ç†
â”‚       â”‚   â”‚   â”œâ”€â”€ BaseDecoderTrack.kt   # è§£ç è½¨é“åŸºç±»
â”‚       â”‚   â”‚   â”œâ”€â”€ VideoDecoderTrack.kt  # è§†é¢‘è§£ç è½¨é“
â”‚       â”‚   â”‚   â””â”€â”€ AudioDecoderTrack.kt  # éŸ³é¢‘è§£ç è½¨é“
â”‚       â”‚   â””â”€â”€ model/                    # è§£ç ç›¸å…³æ•°æ®æ¨¡å‹
â”‚       â”‚       â”œâ”€â”€ TrackSegment.kt       # è½¨é“ç‰‡æ®µ
â”‚       â”‚       â”œâ”€â”€ SampleState.kt        # é‡‡æ ·çŠ¶æ€
â”‚       â”‚       â””â”€â”€ TimeRange.kt          # æ—¶é—´èŒƒå›´
â”‚       â”‚
â”‚       â”œâ”€â”€ export/                        # å¯¼å‡ºåŠŸèƒ½æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ EncodeManager.kt           # å¯¼å‡ºç®¡ç†å™¨ï¼ˆåè°ƒéŸ³è§†é¢‘ç¼–ç ï¼‰
â”‚       â”‚   â”œâ”€â”€ IMediaMuxer.kt             # åª’ä½“åˆæˆå™¨æ¥å£
â”‚       â”‚   â”œâ”€â”€ DefaultMediaMuxer.kt       # é»˜è®¤åˆæˆå™¨å®ç°
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ writer/                   # ç¼–ç å™¨ï¼ˆå†™å…¥å™¨ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ IEncoder.kt           # ç¼–ç å™¨æ¥å£
â”‚       â”‚   â”‚   â”œâ”€â”€ BaseEncoder.kt        # ç¼–ç å™¨åŸºç±»ï¼ˆç»Ÿä¸€drainé€»è¾‘ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ VideoEncoder.kt       # è§†é¢‘ç¼–ç å™¨ï¼ˆH.264ï¼‰
â”‚       â”‚   â”‚   â””â”€â”€ AudioEncoder.kt       # éŸ³é¢‘ç¼–ç å™¨ï¼ˆAACï¼‰
â”‚       â”‚   â”‚
â”‚       â”‚   â”œâ”€â”€ reader/                   # è§£ç å™¨ï¼ˆè¯»å–å™¨ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ IReader.kt            # è¯»å–å™¨æ¥å£
â”‚       â”‚   â”‚   â”œâ”€â”€ BaseReader.kt         # è¯»å–å™¨åŸºç±»
â”‚       â”‚   â”‚   â”œâ”€â”€ VideoReader.kt        # è§†é¢‘è¯»å–å™¨ï¼ˆSurfaceè¾“å…¥ï¼‰
â”‚       â”‚   â”‚   â””â”€â”€ AudioReader.kt        # éŸ³é¢‘è¯»å–å™¨ï¼ˆPCMè¾“å…¥ï¼‰
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ encoder/                        # å¯¼å‡ºä¸“ç”¨è§£ç å™¨
â”‚       â”‚       â”œâ”€â”€ ExportAudioDecoder.kt       # å¯¼å‡ºéŸ³é¢‘è§£ç å™¨
â”‚       â”‚       â””â”€â”€ ExportAudioDecoderTrack.kt  # å¯¼å‡ºéŸ³é¢‘è½¨é“
â”‚       â”‚
â”‚       â”œâ”€â”€ render/                        # æ¸²æŸ“æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ VideoRenderView.kt         # è§†é¢‘æ¸²æŸ“è§†å›¾ï¼ˆGLSurfaceViewï¼‰
â”‚       â”‚   â”œâ”€â”€ PlayerRenderer.kt          # æ’­æ”¾å™¨æ¸²æŸ“å™¨ï¼ˆOpenGL ESï¼‰
â”‚       â”‚   â””â”€â”€ effect/                    # è§†é¢‘ç‰¹æ•ˆ
â”‚       â”‚
â”‚       â”œâ”€â”€ extractor/                     # åª’ä½“æå–å™¨
â”‚       â”‚   â”œâ”€â”€ IExtractor.kt              # æå–å™¨æ¥å£
â”‚       â”‚   â””â”€â”€ AssetExtractor.kt          # èµ„æºæå–å™¨
â”‚       â”‚
â”‚       â”œâ”€â”€ model/                         # æ ¸å¿ƒæ•°æ®æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ Asset.kt                   # åª’ä½“èµ„æº
â”‚       â”‚   â”œâ”€â”€ ClipAsset.kt               # ç‰‡æ®µèµ„æº
â”‚       â”‚   â”œâ”€â”€ TrackSegment.kt            # è½¨é“ç‰‡æ®µ
â”‚       â”‚   â”œâ”€â”€ TimeRange.kt               # æ—¶é—´èŒƒå›´
â”‚       â”‚   â””â”€â”€ PlayerMessage.kt           # æ’­æ”¾å™¨æ¶ˆæ¯
â”‚       â”‚
â”‚       â”œâ”€â”€ utils/                         # å·¥å…·ç±»
â”‚       â”‚   â”œâ”€â”€ VLog.kt                    # æ—¥å¿—å·¥å…·
â”‚       â”‚   â”œâ”€â”€ TimeExt.kt                 # æ—¶é—´æ‰©å±•å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ MessageUtils.kt            # æ¶ˆæ¯å·¥å…·
â”‚       â”‚   â””â”€â”€ VideoPlaybackDiagnostic.kt # æ’­æ”¾è¯Šæ–­å·¥å…·
â”‚       â”‚
â”‚       â”œâ”€â”€ VMPlayer.kt                     # æ’­æ”¾å™¨å®ç°
â”‚       â””â”€â”€ IPlayer.kt                      # æ’­æ”¾å™¨æ¥å£
â”‚
â”œâ”€â”€ build.gradle                            # é¡¹ç›®æ„å»ºé…ç½®
â”œâ”€â”€ deps.gradle                             # ä¾èµ–ç®¡ç†
â”œâ”€â”€ settings.gradle                         # é¡¹ç›®è®¾ç½®
â””â”€â”€ README.md                               # é¡¹ç›®è¯´æ˜
```

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. æ’­æ”¾å™¨æ¶æ„

```
VMPlayer (æ’­æ”¾å™¨å…¥å£)
    â†“
PlayerThread (è§†é¢‘çº¿ç¨‹) + PlayerThreadAudio (éŸ³é¢‘çº¿ç¨‹)
    â†“
VideoDecoderTrack + AudioDecoderTrack (è½¨é“ç®¡ç†)
    â†“
VideoDecoder + AudioDecoder (MediaCodec è§£ç )
    â†“
PlayerRenderer (OpenGL ES æ¸²æŸ“) + AudioTrack (éŸ³é¢‘æ’­æ”¾)
    â†“
AVSyncManager (éŸ³è§†é¢‘åŒæ­¥)
```

### 2. å¯¼å‡ºæ¶æ„

```
EncodeManager (å¯¼å‡ºç®¡ç†å™¨)
    â†“
â”œâ”€â”€ VideoReader Thread              â”œâ”€â”€ AudioReader Thread
â”‚   â†“ è§£ç                           â”‚   â†“ è§£ç 
â”‚   ExportVideoDecoder              â”‚   ExportAudioDecoder
â”‚   â†“ Surface                       â”‚   â†“ PCMæ•°æ®
â”‚   VideoEncoder                    â”‚   AudioEncoder
â”‚   â†“ H.264ç¼–ç                      â”‚   â†“ AACç¼–ç 
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚             â†“
â”‚        MediaMuxer (åˆæˆMP4)
â”‚             â†“
â”‚        è¾“å‡ºæ–‡ä»¶ (output.mp4)
```

### 3. çº¿ç¨‹æ¨¡å‹

- **ä¸»çº¿ç¨‹**: UIäº¤äº’å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **è§†é¢‘è§£ç çº¿ç¨‹** (HandlerThread): è§†é¢‘è§£ç å’Œæ¸²æŸ“
- **éŸ³é¢‘è§£ç çº¿ç¨‹** (HandlerThread): éŸ³é¢‘è§£ç å’Œæ’­æ”¾
- **GLThread**: OpenGL ES æ¸²æŸ“çº¿ç¨‹
- **å¯¼å‡ºè§†é¢‘çº¿ç¨‹**: è§†é¢‘è¯»å–å’Œç¼–ç 
- **å¯¼å‡ºéŸ³é¢‘çº¿ç¨‹**: éŸ³é¢‘è¯»å–å’Œç¼–ç 

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Kotlin + Java
- **æœ€ä½SDK**: API 21 (Android 5.0)
- **æ ¸å¿ƒæŠ€æœ¯**:
    - MediaCodec (è§†é¢‘ç¼–è§£ç )
    - MediaExtractor (åª’ä½“æ•°æ®æå–)
    - MediaMuxer (åª’ä½“æ–‡ä»¶åˆæˆ)
    - OpenGL ES 2.0 (è§†é¢‘æ¸²æŸ“)
    - AudioTrack (éŸ³é¢‘æ’­æ”¾)
    - HandlerThread (çº¿ç¨‹ç®¡ç†)
    - Coroutines (åç¨‹-ç”¨äºå¯¼å‡ºæµç¨‹)

## ä½¿ç”¨ç¤ºä¾‹

### æ’­æ”¾è§†é¢‘

```kotlin
// åˆ›å»ºæ’­æ”¾å™¨
val player = VMPlayer(context, surfaceView)

// è®¾ç½®æ’­æ”¾åˆ—è¡¨
val segments = listOf(
    TrackSegment(asset1, timeRange1),
    TrackSegment(asset2, timeRange2)
)
player.setSegments(segments)

// æ’­æ”¾æ§åˆ¶
player.prepare()
player.play()
player.pause()
player.seek(positionUs)
player.stop()
```

### å¯¼å‡ºè§†é¢‘

```kotlin
// åˆ›å»ºå¯¼å‡ºç®¡ç†å™¨
val encodeManager = EncodeManager()

// é…ç½®å¯¼å‡ºå‚æ•°
val config = EncodeManager.ExportConfig(
    outputFile = File("/path/to/output.mp4"),
    outputSize = Size(1280, 720),
    videoBitRate = 2000000,  // 2Mbps
    audioBitRate = 128000,   // 128kbps
    frameRate = 30
)

// å¼€å§‹å¯¼å‡º
encodeManager.startExport(
    segments = segments,
    config = config,
    listener = object : EncodeManager.ExportListener {
        override fun onExportStart() {}
        override fun onExportProgress(progress: Float) {}
        override fun onExportComplete(outputFile: File) {}
        override fun onExportError(error: Exception) {}
    }
)
```